
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      // A user can read their own profile, or the profile of a user who has them listed as a friend.
      // Use resource.data for simpler/more efficient rules
      allow read: if request.auth.uid == userId ||
                     request.auth.uid in resource.data.friends ||
                     request.auth.uid in resource.data.friendRequestSent;      // Allow user to create their own profile
      allow create: if request.auth.uid == userId;
      // Allow a user to update their own document.
      allow update: if request.auth.uid == userId;
      // This rule allows any authenticated user to query the 'users' collection.
      // This is necessary for the friend search functionality to work.
      // Importantly, this rule does NOT allow reading individual documents,
      // only performing queries that match the client-side code.
      allow list: if request.auth.uid != null;
    }

    // A user can update ANOTHER user's document, but ONLY under specific conditions
    // related to friend requests or unfriending. This is a consolidated rule.
    match /users/{friendId} {
      allow update: if request.auth.uid != null && (
        // Condition 1: Sending a friend request
        (request.resource.data.friendRequestReceived == resource.data.friendRequestReceived.concat([request.auth.uid])) ||

        // Condition 2: Accepting a friend request
        (request.auth.uid in resource.data.friendRequestSent && request.resource.data.friends == resource.data.friends.concat([request.auth.uid])) ||

        // Condition 3: Unfriending
        (resource.data.friends.hasAny([request.auth.uid]) && request.resource.data.friends == resource.data.friends.removeAll([request.auth.uid]))
      );
    }
    
// Rules for the top-level 'letters' collection
    match /letters/{letterId} {
      
      // A user can create a letter if they are the sender,
      // OR if they are the recipient AND it's a welcome letter from the team.
      allow create: if request.auth.uid == request.resource.data.senderId ||
                       (request.auth.uid == request.resource.data.recipientId &&
                        // --- FIX: Corrected typo 'rnJ...' to 'rmJ...' ---
                        request.resource.data.senderId == "rmJavgs7XPGmQ00EBaMu80pKYO02"); 

      // A user can read a letter if they are the sender, the recipient,
      // OR if it's the master welcome letter.
      allow read: if (request.auth.uid == resource.data.senderId || 
                     request.auth.uid == resource.data.recipientId) ||
                     resource.id == 'xoyahNSWNoDgKanJCADb';

      // --- THIS IS THE MAIN FIX ---
      // Allow two different types of updates:
      allow update: if 
        // 1. The recipient can mark it as read
        (request.auth.uid == resource.data.recipientId &&
         request.resource.data.isRead == true && 
         resource.data.isRead == false) ||
         
        // 2. The sender can add a transcript (as long as it hasn't been read)
        (request.auth.uid == resource.data.senderId &&
         request.resource.data.transcript != resource.data.transcript &&
         resource.data.isRead == false);
      
      // A user can delete a letter if they are the sender OR a recipient.
      allow delete: if request.auth.uid == resource.data.senderId || 
                       request.auth.uid == resource.data.recipientId;
    }

    // Background styles are public and can be read by any authenticated user.
    match /backgroundStyles/{styleId} {
      allow read: if request.auth != null;
    }
  }
}
